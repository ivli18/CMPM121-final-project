(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))o(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const l of s.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&o(l)}).observe(document,{childList:!0,subtree:!0});function n(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerPolicy&&(s.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?s.credentials="include":r.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function o(r){if(r.ep)return;r.ep=!0;const s=n(r);fetch(r.href,s)}})();class Xe{canvas;gl;constructor(t){if(!t)throw new Error("Canvas element is undefined.");this.canvas=t;const n=t.getContext("webgl2");if(!n)throw new Error("Unable to initialize WebGL. Your browser may not support it.");this.gl=n,this.configure(),self.addEventListener("resize",()=>this.resize()),this.resize()}configure(){const t=this.gl;t.enable(t.DEPTH_TEST),t.depthFunc(t.LEQUAL),t.clearColor(.5,.7,1,1),t.clearDepth(1),t.enable(t.CULL_FACE),t.cullFace(t.BACK)}resize(){const t=this.canvas,n=t.clientWidth,o=t.clientHeight;(t.width!==n||t.height!==o)&&(t.width=n,t.height=o),this.gl.viewport(0,0,t.width,t.height)}clear(t=.1,n=.1,o=.12,r=1){const s=this.gl;s.clearColor(t,n,o,r),s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT)}}class Qe{constructor(t){this.tick=t}lastTime=0;running=!1;start(){this.running||(this.running=!0,this.lastTime=performance.now(),requestAnimationFrame(this.frame))}stop(){this.running=!1}frame=t=>{if(!this.running)return;const n=(t-this.lastTime)/1e3;this.lastTime=t;const o=Math.min(n,.1);this.tick(o),requestAnimationFrame(this.frame)}}class Ze{constructor(t,n,o){this.gl=t;const r=this.compileShader(n,t.VERTEX_SHADER),s=this.compileShader(o,t.FRAGMENT_SHADER),l=t.createProgram();if(!l)throw new Error("Failed to create WebGLProgram");if(t.attachShader(l,r),t.attachShader(l,s),t.linkProgram(l),!t.getProgramParameter(l,t.LINK_STATUS)){const c=t.getProgramInfoLog(l);throw t.deleteProgram(l),new Error("Failed to link program: "+c)}t.deleteShader(r),t.deleteShader(s),this.program=l}program;use(){this.gl.useProgram(this.program)}getProgram(){return this.program}getUniformLocation(t){return this.gl.getUniformLocation(this.program,t)}compileShader(t,n){const o=this.gl.createShader(n);if(!o)throw new Error("Failed to create shader");if(this.gl.shaderSource(o,t),this.gl.compileShader(o),!this.gl.getShaderParameter(o,this.gl.COMPILE_STATUS)){const r=this.gl.getShaderInfoLog(o);throw this.gl.deleteShader(o),new Error("Failed to compile shader: "+r)}return o}}var ye=1e-6,te=typeof Float32Array<"u"?Float32Array:Array;function K(){var e=new te(16);return te!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0),e[0]=1,e[5]=1,e[10]=1,e[15]=1,e}function et(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function Ae(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function xe(e,t,n){var o=t[0],r=t[1],s=t[2],l=t[3],c=t[4],f=t[5],a=t[6],h=t[7],g=t[8],d=t[9],v=t[10],R=t[11],y=t[12],w=t[13],b=t[14],A=t[15],m=n[0],i=n[1],p=n[2],C=n[3];return e[0]=m*o+i*c+p*g+C*y,e[1]=m*r+i*f+p*d+C*w,e[2]=m*s+i*a+p*v+C*b,e[3]=m*l+i*h+p*R+C*A,m=n[4],i=n[5],p=n[6],C=n[7],e[4]=m*o+i*c+p*g+C*y,e[5]=m*r+i*f+p*d+C*w,e[6]=m*s+i*a+p*v+C*b,e[7]=m*l+i*h+p*R+C*A,m=n[8],i=n[9],p=n[10],C=n[11],e[8]=m*o+i*c+p*g+C*y,e[9]=m*r+i*f+p*d+C*w,e[10]=m*s+i*a+p*v+C*b,e[11]=m*l+i*h+p*R+C*A,m=n[12],i=n[13],p=n[14],C=n[15],e[12]=m*o+i*c+p*g+C*y,e[13]=m*r+i*f+p*d+C*w,e[14]=m*s+i*a+p*v+C*b,e[15]=m*l+i*h+p*R+C*A,e}function tt(e,t,n){var o=n[0],r=n[1],s=n[2],l,c,f,a,h,g,d,v,R,y,w,b;return t===e?(e[12]=t[0]*o+t[4]*r+t[8]*s+t[12],e[13]=t[1]*o+t[5]*r+t[9]*s+t[13],e[14]=t[2]*o+t[6]*r+t[10]*s+t[14],e[15]=t[3]*o+t[7]*r+t[11]*s+t[15]):(l=t[0],c=t[1],f=t[2],a=t[3],h=t[4],g=t[5],d=t[6],v=t[7],R=t[8],y=t[9],w=t[10],b=t[11],e[0]=l,e[1]=c,e[2]=f,e[3]=a,e[4]=h,e[5]=g,e[6]=d,e[7]=v,e[8]=R,e[9]=y,e[10]=w,e[11]=b,e[12]=l*o+h*r+R*s+t[12],e[13]=c*o+g*r+y*s+t[13],e[14]=f*o+d*r+w*s+t[14],e[15]=a*o+v*r+b*s+t[15]),e}function nt(e,t,n){var o=n[0],r=n[1],s=n[2];return e[0]=t[0]*o,e[1]=t[1]*o,e[2]=t[2]*o,e[3]=t[3]*o,e[4]=t[4]*r,e[5]=t[5]*r,e[6]=t[6]*r,e[7]=t[7]*r,e[8]=t[8]*s,e[9]=t[9]*s,e[10]=t[10]*s,e[11]=t[11]*s,e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function ot(e,t,n){var o=Math.sin(n),r=Math.cos(n),s=t[4],l=t[5],c=t[6],f=t[7],a=t[8],h=t[9],g=t[10],d=t[11];return t!==e&&(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[4]=s*r+a*o,e[5]=l*r+h*o,e[6]=c*r+g*o,e[7]=f*r+d*o,e[8]=a*r-s*o,e[9]=h*r-l*o,e[10]=g*r-c*o,e[11]=d*r-f*o,e}function rt(e,t,n){var o=Math.sin(n),r=Math.cos(n),s=t[0],l=t[1],c=t[2],f=t[3],a=t[8],h=t[9],g=t[10],d=t[11];return t!==e&&(e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=s*r-a*o,e[1]=l*r-h*o,e[2]=c*r-g*o,e[3]=f*r-d*o,e[8]=s*o+a*r,e[9]=l*o+h*r,e[10]=c*o+g*r,e[11]=f*o+d*r,e}function st(e,t,n){var o=Math.sin(n),r=Math.cos(n),s=t[0],l=t[1],c=t[2],f=t[3],a=t[4],h=t[5],g=t[6],d=t[7];return t!==e&&(e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=s*r+a*o,e[1]=l*r+h*o,e[2]=c*r+g*o,e[3]=f*r+d*o,e[4]=a*r-s*o,e[5]=h*r-l*o,e[6]=g*r-c*o,e[7]=d*r-f*o,e}function it(e,t,n,o,r){var s=1/Math.tan(t/2);if(e[0]=s/n,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=s,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,r!=null&&r!==1/0){var l=1/(o-r);e[10]=(r+o)*l,e[14]=2*r*o*l}else e[10]=-1,e[14]=-2*o;return e}var at=it;function ct(e,t,n,o){var r,s,l,c,f,a,h,g,d,v,R=t[0],y=t[1],w=t[2],b=o[0],A=o[1],m=o[2],i=n[0],p=n[1],C=n[2];return Math.abs(R-i)<ye&&Math.abs(y-p)<ye&&Math.abs(w-C)<ye?Ae(e):(h=R-i,g=y-p,d=w-C,v=1/Math.sqrt(h*h+g*g+d*d),h*=v,g*=v,d*=v,r=A*d-m*g,s=m*h-b*d,l=b*g-A*h,v=Math.sqrt(r*r+s*s+l*l),v?(v=1/v,r*=v,s*=v,l*=v):(r=0,s=0,l=0),c=g*l-d*s,f=d*r-h*l,a=h*s-g*r,v=Math.sqrt(c*c+f*f+a*a),v?(v=1/v,c*=v,f*=v,a*=v):(c=0,f=0,a=0),e[0]=r,e[1]=c,e[2]=h,e[3]=0,e[4]=s,e[5]=f,e[6]=g,e[7]=0,e[8]=l,e[9]=a,e[10]=d,e[11]=0,e[12]=-(r*R+s*y+l*w),e[13]=-(c*R+f*y+a*w),e[14]=-(h*R+g*y+d*w),e[15]=1,e)}function Se(){var e=new te(3);return te!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function k(e,t,n){var o=new te(3);return o[0]=e,o[1]=t,o[2]=n,o}function lt(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e}function ke(e,t,n,o){return e[0]=t,e[1]=n,e[2]=o,e}function me(e,t){var n=t[0]-e[0],o=t[1]-e[1],r=t[2]-e[2];return Math.sqrt(n*n+o*o+r*r)}(function(){var e=Se();return function(t,n,o,r,s,l){var c,f;for(n||(n=3),o||(o=0),r?f=Math.min(r*n+o,t.length):f=t.length,c=o;c<f;c+=n)e[0]=t[c],e[1]=t[c+1],e[2]=t[c+2],s(e,e,l),t[c]=e[0],t[c+1]=e[1],t[c+2]=e[2];return t}})();class z{static initialized=!1;static keysDown=new Set;static keysPressed=new Set;static keysReleased=new Set;static init(t=window){this.initialized||(this.initialized=!0,t.addEventListener("keydown",n=>{this.keysDown.has(n.code)||this.keysPressed.add(n.code),this.keysDown.add(n.code)}),t.addEventListener("keyup",n=>{this.keysDown.delete(n.code),this.keysReleased.add(n.code)}))}static simulateKeyPress(t){this.keysPressed.add(t)}static update(){this.keysPressed.clear(),this.keysReleased.clear()}static isKeyDown(t){return this.keysDown.has(t)}static wasKeyPressed(t){return this.keysPressed.has(t)}static wasKeyReleased(t){return this.keysReleased.has(t)}}class dt{canvas;jumpButton;interactButton;upButton;downButton;leftButton;rightButton;activeDirections={up:!1,down:!1,left:!1,right:!1};constructor(t){this.canvas=t,this.upButton=this.createButton("â†‘","9rem","4rem","none"),this.downButton=this.createButton("â†“","3rem","4rem","none"),this.leftButton=this.createButton("â†","6rem","1rem","none"),this.rightButton=this.createButton("â†’","6rem","7rem","none"),this.jumpButton=document.createElement("button"),this.jumpButton.textContent="â†‘",this.jumpButton.style.cssText=`
      position: fixed;
      bottom: 6rem;
      right: 2rem;
      width: 70px;
      height: 70px;
      font-size: 32px;
      border-radius: 50%;
      border: 2px solid rgba(255,255,255,0.3);
      background: rgba(100,100,100,0.7);
      color: white;
      z-index: 1000;
      touch-action: none;
    `,document.body.appendChild(this.jumpButton),this.interactButton=document.createElement("button"),this.interactButton.textContent="E",this.interactButton.style.cssText=`
      position: fixed;
      bottom: 6rem;
      right: 6rem;
      width: 70px;
      height: 70px;
      font-size: 24px;
      border-radius: 50%;
      border: 2px solid rgba(255,255,255,0.3);
      background: rgba(100,100,200,0.7);
      color: white;
      z-index: 1000;
      touch-action: none;
    `,document.body.appendChild(this.interactButton),this.setupListeners()}createButton(t,n,o,r){const s=document.createElement("button");return s.textContent=t,s.style.cssText=`
      position: fixed;
      bottom: ${n};
      left: ${o};
      transform: ${r};
      width: 60px;
      height: 60px;
      font-size: 28px;
      border-radius: 50%;
      border: 2px solid rgba(255,255,255,0.3);
      background: rgba(100,100,100,0.7);
      color: white;
      z-index: 1000;
      touch-action: none;
    `,document.body.appendChild(s),s}setupListeners(){this.setupDirectionButton(this.upButton,"up"),this.setupDirectionButton(this.downButton,"down"),this.setupDirectionButton(this.leftButton,"left"),this.setupDirectionButton(this.rightButton,"right"),this.jumpButton.addEventListener("touchstart",t=>{t.preventDefault(),z.simulateKeyPress("Space")}),this.interactButton.addEventListener("touchstart",t=>{t.preventDefault(),z.simulateKeyPress("KeyE")})}setupDirectionButton(t,n){t.addEventListener("touchstart",o=>{o.preventDefault(),this.activeDirections[n]=!0}),t.addEventListener("touchend",o=>{o.preventDefault(),this.activeDirections[n]=!1}),t.addEventListener("touchcancel",o=>{o.preventDefault(),this.activeDirections[n]=!1})}getMovementVector(){let t=0,n=0;if(this.activeDirections.up&&(n-=1),this.activeDirections.down&&(n+=1),this.activeDirections.left&&(t-=1),this.activeDirections.right&&(t+=1),t!==0&&n!==0){const o=Math.sqrt(t*t+n*n);t/=o,n/=o}return{x:t,z:n}}updateButtonTheme(t){const n=t==="dark"?"rgba(100,100,100,0.7)":"rgba(150,150,150,0.7)";this.jumpButton.style.background=n,this.upButton.style.background=n,this.downButton.style.background=n,this.leftButton.style.background=n,this.rightButton.style.background=n;const o=t==="dark"?"rgba(100,100,200,0.7)":"rgba(120,120,220,0.7)";this.interactButton.style.background=o}}const M=document.createElement("button");M.id="langBtn";M.textContent="Language";document.body.appendChild(M);M.style.position="fixed";M.style.top="1rem";M.style.left="1rem";M.style.padding="0.4rem 0.8rem";M.style.borderRadius="0.4rem";M.style.border="none";M.style.cursor="pointer";M.style.fontFamily="system-ui, sans-serif";M.style.zIndex="10";function Te(e){e==="dark"?(M.style.backgroundColor="#222222dd",M.style.color="#f5f5f5",M.style.boxShadow="0 0 8px rgba(0, 0, 0, 0.7)"):(M.style.backgroundColor="#ffffffdd",M.style.color="#111111",M.style.boxShadow="0 0 8px rgba(0, 0, 0, 0.15)")}let ae=Pe();Te(ae);let de=null;if(window.matchMedia){const e=window.matchMedia("(prefers-color-scheme: dark)"),t=n=>{ae=n.matches?"dark":"light",Te(ae),de&&de.updateButtonTheme(ae)};t(e),e.addEventListener?e.addEventListener("change",t):e.addListener(t)}const D={en:{button:"Language",interact:"Press 'E' to interact",doorNeedKey:"You need a {color} key",doorOpen:"Opened {color} door",winMessage:"You Win!",keyPickup:"Picked up {color} key"},zh:{button:"è¯­è¨€",interact:"æŒ‰ 'E' è¿›è¡Œäº’åŠ¨",doorNeedKey:"ä½ éœ€è¦ä¸€æŠŠ{color}é’¥åŒ™",doorOpen:"æ‰“å¼€äº†{color}é—¨",winMessage:"ä½ èµ¢äº†ï¼",keyPickup:"æ¡èµ·äº†{color}é’¥åŒ™"},ar:{button:"Ø§Ù„Ù„ØºØ©",interact:"Ø§Ø¶ØºØ· 'E' Ù„Ù„ØªÙØ§Ø¹Ù„",doorNeedKey:"ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ù…ÙØªØ§Ø­ {color}",doorOpen:"ØªÙ… ÙØªØ­ Ø¨Ø§Ø¨ {color}",winMessage:"Ù„Ù‚Ø¯ ÙØ²Øª!",keyPickup:"Ø§Ù„ØªÙ‚Ø·Øª Ù…ÙØªØ§Ø­ {color}"}};function ft(e){const t=D[e]||D.en;document.getElementById("langBtn").textContent=t.button}document.getElementById("langBtn").addEventListener("click",()=>{const e=document.documentElement;e.lang==="en"?e.lang="zh":e.lang==="zh"?(e.lang="ar",e.dir="rtl"):(e.lang="en",e.dir="ltr"),ft(e.lang)});const ht=`#version 300 es
layout(location = 0) in vec3 aPosition;
layout(location = 1) in vec3 aColor;

uniform mat4 uMVP;

out vec3 vColor;

void main() {
  vColor = aColor;
  gl_Position = uMVP * vec4(aPosition, 1.0);
}
`,pt=`#version 300 es
precision highp float;

in vec3 vColor;
out vec4 outColor;

uniform vec3 uAmbientColor;

void main() {
  // Simple "lighting": base color modulated by ambient theme color
  vec3 litColor = vColor * uAmbientColor;
  outColor = vec4(litColor, 1.0);
}
`,I={inventory:{held:null},keys:new Map,doors:new Map},W=new Map,J={held:null};function Pe(){return globalThis.matchMedia&&globalThis.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"}class yt{nextEntity=1;transforms=new Map;renderables=new Map;physicsBodies=new Map;collectibles=new Map;interactables=new Map;winConditions=new Map;platforms=new Map;players=new Set;createEntity(){return this.nextEntity++}}const mt={playerStart:[0,.5,0],winconPos:[0,7.5,-1],collectibles:[[0,3.5,-3],[0,1.5,3],[0,5.5,-8]],platforms:[{pos:[0,3,-3],size:[3,.5,3]},{pos:[0,1,3],size:[3,.5,3]},{pos:[0,5,-8],size:[3,.5,3]},{pos:[0,7,-1],size:[3,.5,3]}],keys:[{id:"keyRed1",color:"ðŸŸ¥",pos:[2,1,-5]},{id:"keyBlue1",color:"ðŸŸ¦",pos:[-2,1,-5]}],doors:[]},ut={playerStart:[0,.5,0],winconPos:[0,9.5,-12],collectibles:[[4,2.5,-2],[-4,4.5,-5],[3,6.5,-9],[-3,8.5,-11]],platforms:[{pos:[1,2,-2],size:[4,.5,4]},{pos:[-4,4,-5],size:[3,.5,3]},{pos:[3,5,-9],size:[4,.5,4]},{pos:[-3,7,-10],size:[3,.5,3]},{pos:[0,9,-12],size:[3,.5,3]}],keys:[],doors:[{id:"doorRed1",color:"ðŸŸ¥",pos:[-.7,4.5,-2],size:[.5,5,3.9]}]};function G(e,t,n,o,r){const s=e.createVertexArray();if(!s)throw new Error("Failed to create VAO");e.bindVertexArray(s);const l=t.length/3,c=6,f=new Float32Array(l*c);for(let d=0;d<l;d++)f[d*c+0]=t[d*3+0],f[d*c+1]=t[d*3+1],f[d*c+2]=t[d*3+2],f[d*c+3]=n[d*3+0],f[d*c+4]=n[d*3+1],f[d*c+5]=n[d*3+2];const a=e.createBuffer();if(!a)throw new Error("Failed to create VBO");e.bindBuffer(e.ARRAY_BUFFER,a),e.bufferData(e.ARRAY_BUFFER,f,e.STATIC_DRAW);const h=e.createBuffer();if(!h)throw new Error("Failed to create IBO");e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,h),e.bufferData(e.ELEMENT_ARRAY_BUFFER,new Uint16Array(o),e.STATIC_DRAW);const g=c*4;return e.enableVertexAttribArray(0),e.vertexAttribPointer(0,3,e.FLOAT,!1,g,0),e.enableVertexAttribArray(1),e.vertexAttribPointer(1,3,e.FLOAT,!1,g,3*4),e.bindVertexArray(null),e.bindBuffer(e.ARRAY_BUFFER,null),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null),{vao:s,indexCount:o.length,mode:r}}function ie(e){const{world:t,size:n,pos:o,move:r,density:s=1}=e;return t.add({type:"box",size:n,pos:o,rot:[0,0,0],move:r,density:s})}function V(e){const t=e.matrix;Ae(t),tt(t,t,e.position),ot(t,t,e.rotation[0]),rt(t,t,e.rotation[1]),st(t,t,e.rotation[2]),nt(t,t,e.scale)}function gt(e){const t=D[document.documentElement.lang]||D.en;"collect"in e?(e.collect(),J.held=e.color,O(t.keyPickup.replace("{color}",e.color),1.5)):"open"in e&&(J.held===e.color?(O(t.doorOpen.replace("{color}",e.color),1.5),e.isOpen=!0):O(t.doorNeedKey.replace("{color}",e.color),1.5))}function vt(e,t,n,o,r,s,l){const c=n.createEntity(),f={position:k(r.playerStart[0],r.playerStart[1],r.playerStart[2]),rotation:k(0,0,0),scale:k(1,1,1),matrix:K()};V(f),n.transforms.set(c,f),n.renderables.set(c,{drawable:o.playerCube});const a=ie({world:t,size:[1,1,1],pos:r.playerStart,move:!0,density:1});n.physicsBodies.set(c,{body:a}),n.players.add(c);const h=n.createEntity(),g={position:k(0,0,0),rotation:k(0,0,0),scale:k(1,1,1),matrix:K()};V(g),n.transforms.set(h,g),n.renderables.set(h,{drawable:o.floorGrid});const d=ie({world:t,size:[s*2,1,s*2],pos:[0,-.5,0],move:!1});n.physicsBodies.set(h,{body:d}),n.platforms.set(h,{topY:0});const v=n.createEntity(),R={position:k(r.winconPos[0],r.winconPos[1],r.winconPos[2]),rotation:k(0,0,0),scale:k(1,1,1),matrix:K()};V(R),n.transforms.set(v,R),n.renderables.set(v,{drawable:o.winPyramid}),n.winConditions.set(v,{completed:!1,triggerRadius:1}),r.collectibles.forEach((y,w)=>{const b=`scene${l}_c${w}`;if(W.get(b))return;W.has(b)||W.set(b,!1);const A=n.createEntity(),m={position:k(y[0],y[1],y[2]),rotation:k(0,0,0),scale:k(1,1,1),matrix:K()};V(m),n.transforms.set(A,m),n.renderables.set(A,{drawable:o.collectibleCube}),n.collectibles.set(A,{id:b,isCollected:!1,triggerRadius:1})});for(const y of r.keys??[]){I.keys.has(y.id)||I.keys.set(y.id,{color:y.color,collected:!1});const w=I.keys.get(y.id);if(w.collected)continue;const b=n.createEntity(),A={position:k(...y.pos),rotation:k(0,0,0),scale:k(1,1,1),matrix:K()};V(A),n.transforms.set(b,A);const m=w.color==="ðŸŸ¥"?o.keyRedTriangle:o.keyBlueTriangle;n.renderables.set(b,{drawable:m}),n.interactables.set(b,{triggerRadius:1,color:w.color,collect(){w.collected=!0,I.inventory.held=w.color;const i=D[document.documentElement.lang]||D.en;O(i.keyPickup.replace("{color}",w.color),1.5),n.renderables.delete(b),n.interactables.delete(b)},onInteract(){gt(this)}})}for(const y of r.doors??[]){I.doors.has(y.id)||I.doors.set(y.id,{color:y.color,isOpen:!1});const w=I.doors.get(y.id);if(w.isOpen)continue;const b=n.createEntity(),A={position:k(...y.pos),rotation:k(0,0,0),scale:k(...y.size),matrix:K()};V(A),n.transforms.set(b,A);const m=w.color==="ðŸŸ¥"?o.doorRedCube:o.doorBlueCube;n.renderables.set(b,{drawable:m});const i=ie({world:t,size:y.size,pos:y.pos,move:!1});n.physicsBodies.set(b,{body:i}),n.interactables.set(b,{triggerRadius:2,color:w.color,isOpen:w.isOpen,open(){w.isOpen=!0;const p=D[document.documentElement.lang]||D.en;O(p.doorOpen.replace("{color}",w.color),1.5),t.removeRigidBody(i),n.renderables.delete(b),n.physicsBodies.delete(b),n.interactables.delete(b)},onInteract(){const p=D[document.documentElement.lang]||D.en;J.held===this.color&&!this.isOpen?this.open():J.held!==this.color&&O(p.doorNeedKey.replace("{color}",this.color),1.5)}})}for(const y of r.platforms){const[w,b,A]=y.pos,[m,i,p]=y.size,C=n.createEntity(),N={position:k(w,b,A),rotation:k(0,0,0),scale:k(m,i,p),matrix:K()};V(N),n.transforms.set(C,N),n.renderables.set(C,{drawable:o.platformCube});const q=ie({world:t,size:[m,i,p],pos:[w,b,A],move:!1});n.physicsBodies.set(C,{body:q});const $=b+i/2;n.platforms.set(C,{topY:$})}return{playerEntity:c}}let ce=null,le=0;function O(e,t=.5){ce=e,le=t}function bt(){z.init();const e=document.getElementById("game");if(!e)throw new Error("Canvas element with id 'game' not found");e.style.touchAction="none",e.style.userSelect="none",de=new dt(e);const t=document.getElementById("ui"),n=t.getContext("2d"),o="platform_oimo_save_v1";function r(){const E=i.physicsBodies.get(N),u=i.transforms.get(N);if(!E||!u)return;const B=E.body;typeof B.getLinearVelocity=="function"?B.getLinearVelocity():B.linearVelocity;const L={version:1,sceneIndex:p,playerPos:[u.position[0],u.position[1],u.position[2]],inventoryHeld:J.held,keys:{},doors:{},collectibles:{}};for(const[S,F]of I.keys)L.keys[S]={...F};for(const[S,F]of I.doors)L.doors[S]={...F};for(const[S,F]of W)L.collectibles[S]=F;localStorage.setItem(o,JSON.stringify(L)),O("Game saved",1)}function s(){const E=localStorage.getItem(o);if(!E){O("No save found",1);return}let u;try{u=JSON.parse(E)}catch(S){console.error("Failed to parse save data",S),O("Save data corrupted",1);return}if(u.version!==1){O("Save version mismatch",1);return}J.held=u.inventoryHeld,I.inventory.held=u.inventoryHeld,I.keys.clear();for(const S in u.keys)I.keys.set(S,u.keys[S]);I.doors.clear();for(const S in u.doors)I.doors.set(S,u.doors[S]);W.clear();for(const S in u.collectibles)W.set(S,u.collectibles[S]);p=u.sceneIndex,m=re(p);const B=i.physicsBodies.get(N),L=i.transforms.get(N);if(B&&L){const[S,F,j]=u.playerPos;ke(L.position,S,F,j),V(L);const Q=B.body.getPosition();Q.x=S,Q.y=F,Q.z=j}O("Game loaded",1)}function l(){localStorage.removeItem(o),J.held=null,I.inventory.held=null,I.keys.clear(),I.doors.clear(),W.clear(),p=0,m=re(p),O("New game",1)}function c(E){n.clearRect(0,0,t.width,t.height),ce&&(n.font="20px Arial",n.fillStyle=b,n.textAlign="center",n.fillText(ce,t.width/2,t.height-50),le-=E,le<=0&&(ce=null))}const f=new Xe(e),a=f.gl,h=new Ze(a,ht,pt),g=h.getUniformLocation("uMVP");if(!g)throw new Error("Failed to get uMVP uniform");const d=h.getUniformLocation("uAmbientColor");if(!d)throw new Error("Failed to get uAmbientColor uniform");let v=Pe();function R(E){return E==="dark"?[.6,.6,.7]:[1,1,1]}function y(E){return E==="dark"?[.1,.1,.15,1]:[.9,.9,1,1]}function w(E){return E==="dark"?"#ffffff":"#111111"}let b=w(v);if(globalThis.matchMedia){const E=globalThis.matchMedia("(prefers-color-scheme: dark)"),u=B=>{v=B.matches?"dark":"light",b=w(v)};u(E),E.addEventListener("change",u)}function A(){const[E,u,B,L]=y(v);a.clearColor(E,u,B,L),a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT)}let m=new OIMO.World({timestep:1/60,iterations:8,broadphase:2,worldscale:1,random:!0,info:!1,gravity:[0,-9.8,0]});const i=new yt;let p=0;const C=[mt,ut];let N;const q=[-.5,-.5,.5,.5,-.5,.5,.5,.5,.5,-.5,.5,.5,-.5,-.5,-.5,.5,-.5,-.5,.5,.5,-.5,-.5,.5,-.5],$=[0,1,2,0,2,3,1,5,6,1,6,2,5,4,7,5,7,6,4,0,3,4,3,7,3,2,6,3,6,7,4,5,1,4,1,0],Re=[1,0,0,1,.3,.3,1,.3,.3,1,0,0,1,.6,.2,1,.8,.3,1,.8,.3,1,.6,.2],Le=[0,1,1,0,1,1,0,1,1,0,1,1,0,.8,.8,0,.8,.8,0,.8,.8,0,.8,.8],Me=G(a,q,[1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0],$,a.TRIANGLES),ze=G(a,q,[0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1],$,a.TRIANGLES),ue=[0,.5,0,-.5,-.5,0,.5,-.5,0,0,.5,-.2,-.5,-.5,-.2,.5,-.5,-.2],ge=[0,1,2,3,5,4,0,3,1,1,3,4,1,4,2,2,4,5,2,5,0,0,5,3],Ie=[1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0],De=[0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1],Fe=G(a,ue,Ie,ge,a.TRIANGLES),Oe=G(a,ue,De,ge,a.TRIANGLES),Ke=[.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5],_e=G(a,q,Re,$,a.TRIANGLES),Ve=G(a,q,Le,$,a.TRIANGLES),Ne=G(a,q,Ke,$,a.TRIANGLES),Ue=G(a,[-.3,0,-.3,.3,0,-.3,.3,0,.3,-.3,0,.3,0,.6,0],[1,1,0,1,1,0,1,1,0,1,1,0,1,1,.5],[0,1,2,0,2,3,0,4,1,1,4,2,2,4,3,3,4,0],a.TRIANGLES),U=10,ne=20,oe=0,Z=[],fe=[],he=[];for(let E=0;E<=ne;E++){const u=-U+2*U*E/ne,B=Z.length/3;Z.push(-U,oe,u,U,oe,u),fe.push(.8,.8,.8,.8,.8,.8),he.push(B,B+1)}for(let E=0;E<=ne;E++){const u=-U+2*U*E/ne,B=Z.length/3;Z.push(u,oe,-U,u,oe,U),fe.push(.8,.8,.8,.8,.8,.8),he.push(B,B+1)}const Ge=G(a,Z,fe,he,a.LINES),Ye={playerCube:_e,collectibleCube:Ve,platformCube:Ne,winPyramid:Ue,floorGrid:Ge,keyRedTriangle:Fe,keyBlueTriangle:Oe,doorRedCube:Me,doorBlueCube:ze};m=re(p);function re(E){i.transforms.clear(),i.renderables.clear(),i.physicsBodies.clear(),i.collectibles.clear(),i.winConditions.clear(),i.platforms.clear(),i.players.clear();const u=new OIMO.World({timestep:1/60,iterations:8,broadphase:2,worldscale:1,random:!0,info:!1,gravity:[0,-9.8,0]});return N=vt(a,u,i,Ye,C[E],U,E).playerEntity,u}const ve=K(),be=K(),we=K(),Ee=K(),Ce=K(),Y=Se();function He(){const E=f.canvas.width/f.canvas.height;at(ve,80*Math.PI/180,E,.1,100);const u=k(Y[0]+5,Y[1]+5,Y[2]+5),B=Y,L=k(0,1,0);ct(be,u,B,L),xe(we,ve,be)}let se=0;const Be=1/60,X=5,We=6.5,qe=.5;let pe=!1;new Qe(E=>{A();const u=i.physicsBodies.get(N);if(!u)return;const B=u.body,L=typeof B.getLinearVelocity=="function"?B.getLinearVelocity():B.linearVelocity,S=de?.getMovementVector()??{x:0,z:0};let F=0,j=0;for((z.isKeyDown("ArrowUp")||z.isKeyDown("KeyW"))&&(j-=X),(z.isKeyDown("ArrowDown")||z.isKeyDown("KeyS"))&&(j+=X),(z.isKeyDown("ArrowLeft")||z.isKeyDown("KeyA"))&&(F-=X),(z.isKeyDown("ArrowRight")||z.isKeyDown("KeyD"))&&(F+=X),F+=S.x*X,j+=S.z*X,L.x=F,L.z=j,z.wasKeyPressed("Space")&&pe&&(L.y=We),typeof B.setLinearVelocity=="function"?B.setLinearVelocity(L):B.linearVelocity=L,se+=E;se>=Be;)m.step(),se-=Be;for(const[T,P]of i.physicsBodies){const x=i.transforms.get(T);if(!x)continue;const _=P.body.getPosition();ke(x.position,_.x,_.y,_.z),V(x)}const ee=i.transforms.get(N);if(ee&&lt(Y,ee.position),pe=!1,ee&&u){const T=u.body,x=(typeof T.getLinearVelocity=="function"?T.getLinearVelocity():T.linearVelocity).y;for(const[,_]of i.platforms){const H=_.topY+qe;if(Math.abs(ee.position[1]-H)<.05&&x<=.1){pe=!0;break}}}for(const[T,P]of i.collectibles){if(P.isCollected)continue;const x=i.transforms.get(T);x&&(x.rotation[1]+=2*E,V(x))}for(const[T,P]of i.winConditions){if(P.completed)continue;const x=i.transforms.get(T);x&&(x.rotation[1]+=2*E,V(x))}let Q=!0;for(const[,T]of i.collectibles)if(!T.isCollected){Q=!1;break}for(const[T,P]of i.collectibles){if(P.isCollected)continue;const x=i.transforms.get(T);if(!x)continue;me(Y,x.position)<P.triggerRadius&&(P.isCollected=!0,W.set(P.id,!0),console.log("Collectible picked up:",T))}for(const[T,P]of i.interactables){const x=i.transforms.get(T);if(!x)continue;if(me(Y,x.position)<P.triggerRadius){if(le<=0){const H=D[document.documentElement.lang]||D.en;O(H.interact,.5)}z.wasKeyPressed("KeyE")&&P.onInteract()}}if(Q)for(const[T,P]of i.winConditions){if(P.completed)continue;const x=i.transforms.get(T);if(!x)continue;if(me(Y,x.position)<P.triggerRadius)if(P.completed=!0,p++,p<C.length)console.log(`Loading scene ${p+1}...`),m=re(p),se=0;else{const H=D[document.documentElement.lang]||D.en;alert(H.winMessage)}}He(),h.use();const[$e,je,Je]=R(v);a.uniform3f(d,$e,je,Je);for(const[T,P]of i.renderables){const x=i.transforms.get(T);if(!x)continue;const _=i.collectibles.get(T);if(_&&_.isCollected)continue;const H=i.winConditions.get(T);H&&H.completed||(a.bindVertexArray(P.drawable.vao),xe(Ce,we,x.matrix),et(Ee,Ce),a.uniformMatrix4fv(g,!1,Ee),a.drawElements(P.drawable.mode,P.drawable.indexCount,a.UNSIGNED_SHORT,0))}a.bindVertexArray(null),z.wasKeyPressed("KeyP")&&r(),z.wasKeyPressed("KeyL")&&s(),z.wasKeyPressed("KeyN")&&l(),c(E),z.update()}).start()}bt();
//# sourceMappingURL=index-D28_gpU4.js.map
